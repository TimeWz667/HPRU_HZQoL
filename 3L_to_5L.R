library(data.table)
library(ggplot2)

# From van Hout and Shaw, 
# https://www.valueinhealthjournal.com/article/S1098-3015(21)00170-4

parameters = fread(
"param, Mo, MoSE, SC, SCSE, UA, UASE, PD, PDSE, AD, ADSE
a1, 3.933, 0.188, 6.091, 0.347, 3.291, 0.172, 2.243, 0.101, 2.027, 0.094
a2, 9.472, 0.437, 11.673, 0.579, 8.822, 0.405, 7.442, 0.288, 6.428, 0.227
a3, 12.135, 0.493, 14.608, 0.658, 11.940, 0.495, 10.216, 0.313, 9.001, 0.253
a4, 18.118, 0.779, 18.481, 0.844, 16.474, 0.658, 14.473, 0.425, 13.131, 0.395
b2mo, 8.019, 0.400, 2.221, 0.276, 0.906, 0.154, 0.771, 0.118, -0.225, 0.124
b3mo, 14.996, 0.793, 4.076, 0.477, 2.901, 0.457, 0.953, 0.315, 0.052, 0.315
b2sc, 1.499, 0.147, 7.957, 0.433, 1.421, 0.152, 0.818, 0.118, 0.240, 0.123
b3sc, 2.165, 0.370, 13.817, 0.748, 2.513, 0.402, 1.170, 0.297, 0.188, 0.297
b2ua, 0.904, 0.171, 0.996, 0.301, 7.361, 0.369, 0.791, 0.118, 0.541, 0.117
b3ua, 2.063, 0.255, 2.607, 0.359, 12.812, 0.568, 1.056, 0.195, 1.351, 0.192
b2pd, 0.472, 0.159, -0.063, 0.231, 0.250, 0.143, 6.239, 0.274, 0.031, 0.107
b3pd, 2.235, 0.250, 0.089, 0.291, 1.096, 0.238, 10.930, 0.394, 0.019, 0.185
b2ad, -0.019, 0.123, 0.480, 0.163, 0.678, 0.121, 0.091, 0.094, 6.046, 0.220
b3ad, -0.287, 0.224, 0.773, 0.270, 1.767, 0.220, 0.547, 0.167, 11.517, 0.379
th, 1.000, 0.000, 1.055, 0.133, 1.146, 0.158, 0.523, 0.075, 0.460, 0.072
s2, 1.121, 0.049, 0, 0, 0, 0, 0, 0, 0, 0")

# The returned value is: given that your 3L code is X (e.g. "12323"), then
# for dimension k (e.g. "Mo", "SC", "UA", "PD", or "AD") what is the 
# probability that your 5L score is i (i in 1, 2, 3, 4, 5)?
EQ5D_3L_to_5L = function(X, k, i)
{
    xd = function(i) as.numeric(substr(X, i, i))
    x = as.numeric(c(
        xd(1) == 2, xd(1) == 3,
        xd(2) == 2, xd(2) == 3,
        xd(3) == 2, xd(3) == 3,
        xd(4) == 2, xd(4) == 3,
        xd(5) == 2, xd(5) == 3
    ))
    
    m_r = 0

    b = parameters[[k]][5:14]
    th = parameters[[k]][15]
    s2 = parameters[["Mo"]][16]
    p = NA
    
    if (i == 1) {
        a = parameters[[k]][i]
        y = exp(a - sum(b * x) - m_r)
        p = y / (1 + y)
    } else if (i < 5) {
        a0 = parameters[[k]][i]
        a1 = parameters[[k]][i - 1]
        y0 = exp(a0 - sum(b * x) - m_r)
        y1 = exp(a1 - sum(b * x) - m_r)
        p = y0 / (1 + y0) - y1 / (1 + y1)
    } else if (i == 5) {
        a1 = parameters[[k]][i - 1]
        y1 = exp(a1 - sum(b * x) - m_r)
        p = 1 / (1 + y1)
    }
    
    return (p)
}




EQ5D_3L_to_5L("31111", "Mo", 1)
